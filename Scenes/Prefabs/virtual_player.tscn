[gd_scene load_steps=16 format=3 uid="uid://bjmgb6nib47p2"]

[ext_resource type="Texture2D" uid="uid://cbm1ysh6bgecv" path="res://Sprites/virtual_character_idle.png" id="3_mjglx"]
[ext_resource type="Texture2D" uid="uid://cx516bauljcy5" path="res://Sprites/virtual_character_walk.png" id="4_72j6l"]

[sub_resource type="GDScript" id="GDScript_8e2s1"]
script/source = "extends Area2D

var level_manager
var moving = false
var inputs = {\"left\": Vector2.LEFT,
			\"right\": Vector2.RIGHT,
			\"up\": Vector2.UP,
			\"down\": Vector2.DOWN,
			\"skip_turn\": Vector2.ZERO,
			\"pause\": Vector2.ONE}

@onready var artefact_holder = $/root/Main/ArtefactHolder
@onready var animated_sprite_2d = $AnimatedSprite2D
@onready var ray = $RayCast2D

func _ready():
	level_manager = get_tree().get_first_node_in_group(\"LevelManager\")
	enter_level_animation()

func _unhandled_input(event):
	if moving || level_manager.game_over:
		return
	for dir in inputs.keys():
		if event.is_action_pressed(dir):
			if inputs[dir] == inputs.pause:
				level_manager.press_pause()
				return
			if level_manager.paused:
				return
			if inputs[dir] == inputs.left:
				animated_sprite_2d.flip_h = true
			if inputs[dir] == inputs.right:
				animated_sprite_2d.flip_h = false
			if inputs[dir] == inputs.skip_turn:
				moving = true
				await level_manager.end_turn(level_manager.turn + 1)
				moving = false
				return
			collision_check(dir)

func enter_level_animation():
	moving = true
	animated_sprite_2d.play(\"move\")
	position = get_tree().get_first_node_in_group(\"StartTile\").position.snapped(Vector2.ONE * level_manager.tile_size)
	var tween = create_tween()
	tween.tween_property(self, \"scale\", Vector2(1, 1), 0.8).set_trans(Tween.TRANS_SINE)
	await tween.finished
	animated_sprite_2d.play(\"idle\")
	moving = false

# checks for collision before moving or taking appropriate action
func collision_check(dir):
	ray.target_position = inputs[dir] * level_manager.tile_size
	ray.force_raycast_update()
	if !ray.is_colliding():
		move(dir)
	else:
		var collision = ray.get_collider()
		if not \"tile_type\" in collision:
			return
		match collision.tile_type:
			\"cannon\":
				if artefact_holder.get_strength() < 2 || collision.is_destroyed:
					return
				moving = true
				collision.hit_by_player()
				await level_manager.end_turn(level_manager.turn + 1)
				moving = false
			\"hardened\":
				moving = true
				collision.hit_by_player(artefact_holder.get_strength())
				await level_manager.end_turn(level_manager.turn + 1)
				moving = false
			\"key\", \"artefact\", \"freeze\":
				collision.pick_up()
				move(dir)
			\"door\":
				if collision.unlocked: 
					collision.open_door()
					move(dir)
			_:
				return

# grid based character movement
func move(dir):
		moving = true
		var tween = create_tween()
		tween.tween_property(self, \"position\",
				position + inputs[dir] * level_manager.tile_size,
				1.5/level_manager.animation_speed).set_trans(Tween.TRANS_SINE)
		animated_sprite_2d.play(\"move\")
		await tween.finished
		animated_sprite_2d.play(\"idle\")
		await level_manager.end_turn(level_manager.turn + 1)
		moving = false
"

[sub_resource type="RectangleShape2D" id="RectangleShape2D_ab277"]
size = Vector2(30, 30)

[sub_resource type="AtlasTexture" id="AtlasTexture_3tj8b"]
atlas = ExtResource("3_mjglx")
region = Rect2(0, 0, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_ccjhp"]
atlas = ExtResource("3_mjglx")
region = Rect2(32, 0, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_ecfij"]
atlas = ExtResource("3_mjglx")
region = Rect2(0, 32, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_rkhrx"]
atlas = ExtResource("3_mjglx")
region = Rect2(32, 32, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_atmie"]
atlas = ExtResource("3_mjglx")
region = Rect2(0, 64, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_muv82"]
atlas = ExtResource("3_mjglx")
region = Rect2(32, 64, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_uucmi"]
atlas = ExtResource("4_72j6l")
region = Rect2(0, 0, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_putt6"]
atlas = ExtResource("4_72j6l")
region = Rect2(32, 0, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_4pqko"]
atlas = ExtResource("4_72j6l")
region = Rect2(0, 32, 32, 32)

[sub_resource type="AtlasTexture" id="AtlasTexture_h250l"]
atlas = ExtResource("4_72j6l")
region = Rect2(32, 32, 32, 32)

[sub_resource type="SpriteFrames" id="SpriteFrames_85hmi"]
animations = [{
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_3tj8b")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_ccjhp")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_ecfij")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_rkhrx")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_atmie")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_muv82")
}],
"loop": true,
"name": &"idle",
"speed": 5.0
}, {
"frames": [{
"duration": 1.0,
"texture": SubResource("AtlasTexture_uucmi")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_putt6")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_4pqko")
}, {
"duration": 1.0,
"texture": SubResource("AtlasTexture_h250l")
}],
"loop": true,
"name": &"move",
"speed": 8.0
}]

[node name="VirtualPlayer" type="Area2D" groups=["Player"]]
z_index = 3
scale = Vector2(0.6, 0.6)
collision_layer = 2
script = SubResource("GDScript_8e2s1")

[node name="CollisionShape2D" type="CollisionShape2D" parent="."]
shape = SubResource("RectangleShape2D_ab277")

[node name="RayCast2D" type="RayCast2D" parent="."]
target_position = Vector2(-32, 0)
collide_with_areas = true

[node name="AnimationPlayer" type="AnimationPlayer" parent="."]

[node name="AnimatedSprite2D" type="AnimatedSprite2D" parent="."]
sprite_frames = SubResource("SpriteFrames_85hmi")
animation = &"idle"
autoplay = "idle"
frame_progress = 0.764639
